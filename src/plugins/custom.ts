import * as ts from 'typescript';
import type { TransformerFactory } from '@rollup/plugin-typescript';

const kinds = [
  'Unknown',
  'EndOfFileToken',
  'SingleLineCommentTrivia',
  'MultiLineCommentTrivia',
  'NewLineTrivia',
  'WhitespaceTrivia',
  'ShebangTrivia',
  'ConflictMarkerTrivia',
  'NonTextFileMarkerTrivia',
  'NumericLiteral',
  'BigIntLiteral',
  'StringLiteral',
  'JsxText',
  'JsxTextAllWhiteSpaces',
  'RegularExpressionLiteral',
  'NoSubstitutionTemplateLiteral',
  'TemplateHead',
  'TemplateMiddle',
  'TemplateTail',
  'OpenBraceToken',
  'CloseBraceToken',
  'OpenParenToken',
  'CloseParenToken',
  'OpenBracketToken',
  'CloseBracketToken',
  'DotToken',
  'DotDotDotToken',
  'SemicolonToken',
  'CommaToken',
  'QuestionDotToken',
  'LessThanToken',
  'LessThanSlashToken',
  'GreaterThanToken',
  'LessThanEqualsToken',
  'GreaterThanEqualsToken',
  'EqualsEqualsToken',
  'ExclamationEqualsToken',
  'EqualsEqualsEqualsToken',
  'ExclamationEqualsEqualsToken',
  'EqualsGreaterThanToken',
  'PlusToken',
  'MinusToken',
  'AsteriskToken',
  'AsteriskAsteriskToken',
  'SlashToken',
  'PercentToken',
  'PlusPlusToken',
  'MinusMinusToken',
  'LessThanLessThanToken',
  'GreaterThanGreaterThanToken',
  'GreaterThanGreaterThanGreaterThanToken',
  'AmpersandToken',
  'BarToken',
  'CaretToken',
  'ExclamationToken',
  'TildeToken',
  'AmpersandAmpersandToken',
  'BarBarToken',
  'QuestionToken',
  'ColonToken',
  'AtToken',
  'QuestionQuestionToken',
  'BacktickToken',
  'HashToken',
  'EqualsToken',
  'PlusEqualsToken',
  'MinusEqualsToken',
  'AsteriskEqualsToken',
  'AsteriskAsteriskEqualsToken',
  'SlashEqualsToken',
  'PercentEqualsToken',
  'LessThanLessThanEqualsToken',
  'GreaterThanGreaterThanEqualsToken',
  'GreaterThanGreaterThanGreaterThanEqualsToken',
  'AmpersandEqualsToken',
  'BarEqualsToken',
  'BarBarEqualsToken',
  'AmpersandAmpersandEqualsToken',
  'QuestionQuestionEqualsToken',
  'CaretEqualsToken',
  'Identifier',
  'PrivateIdentifier',
  'BreakKeyword',
  'CaseKeyword',
  'CatchKeyword',
  'ClassKeyword',
  'ConstKeyword',
  'ContinueKeyword',
  'DebuggerKeyword',
  'DefaultKeyword',
  'DeleteKeyword',
  'DoKeyword',
  'ElseKeyword',
  'EnumKeyword',
  'ExportKeyword',
  'ExtendsKeyword',
  'FalseKeyword',
  'FinallyKeyword',
  'ForKeyword',
  'FunctionKeyword',
  'IfKeyword',
  'ImportKeyword',
  'InKeyword',
  'InstanceOfKeyword',
  'NewKeyword',
  'NullKeyword',
  'ReturnKeyword',
  'SuperKeyword',
  'SwitchKeyword',
  'ThisKeyword',
  'ThrowKeyword',
  'TrueKeyword',
  'TryKeyword',
  'TypeOfKeyword',
  'VarKeyword',
  'VoidKeyword',
  'WhileKeyword',
  'WithKeyword',
  'ImplementsKeyword',
  'InterfaceKeyword',
  'LetKeyword',
  'PackageKeyword',
  'PrivateKeyword',
  'ProtectedKeyword',
  'PublicKeyword',
  'StaticKeyword',
  'YieldKeyword',
  'AbstractKeyword',
  'AccessorKeyword',
  'AsKeyword',
  'AssertsKeyword',
  'AssertKeyword',
  'AnyKeyword',
  'AsyncKeyword',
  'AwaitKeyword',
  'BooleanKeyword',
  'ConstructorKeyword',
  'DeclareKeyword',
  'GetKeyword',
  'InferKeyword',
  'IntrinsicKeyword',
  'IsKeyword',
  'KeyOfKeyword',
  'ModuleKeyword',
  'NamespaceKeyword',
  'NeverKeyword',
  'OutKeyword',
  'ReadonlyKeyword',
  'RequireKeyword',
  'NumberKeyword',
  'ObjectKeyword',
  'SatisfiesKeyword',
  'SetKeyword',
  'StringKeyword',
  'SymbolKeyword',
  'TypeKeyword',
  'UndefinedKeyword',
  'UniqueKeyword',
  'UnknownKeyword',
  'UsingKeyword',
  'FromKeyword',
  'GlobalKeyword',
  'BigIntKeyword',
  'OverrideKeyword',
  'OfKeyword',
  'QualifiedName',
  'ComputedPropertyName',
  'TypeParameter',
  'Parameter',
  'Decorator',
  'PropertySignature',
  'PropertyDeclaration',
  'MethodSignature',
  'MethodDeclaration',
  'ClassStaticBlockDeclaration',
  'Constructor',
  'GetAccessor',
  'SetAccessor',
  'CallSignature',
  'ConstructSignature',
  'IndexSignature',
  'TypePredicate',
  'TypeReference',
  'FunctionType',
  'ConstructorType',
  'TypeQuery',
  'TypeLiteral',
  'ArrayType',
  'TupleType',
  'OptionalType',
  'RestType',
  'UnionType',
  'IntersectionType',
  'ConditionalType',
  'InferType',
  'ParenthesizedType',
  'ThisType',
  'TypeOperator',
  'IndexedAccessType',
  'MappedType',
  'LiteralType',
  'NamedTupleMember',
  'TemplateLiteralType',
  'TemplateLiteralTypeSpan',
  'ImportType',
  'ObjectBindingPattern',
  'ArrayBindingPattern',
  'BindingElement',
  'ArrayLiteralExpression',
  'ObjectLiteralExpression',
  'PropertyAccessExpression',
  'ElementAccessExpression',
  'CallExpression',
  'NewExpression',
  'TaggedTemplateExpression',
  'TypeAssertionExpression',
  'ParenthesizedExpression',
  'FunctionExpression',
  'ArrowFunction',
  'DeleteExpression',
  'TypeOfExpression',
  'VoidExpression',
  'AwaitExpression',
  'PrefixUnaryExpression',
  'PostfixUnaryExpression',
  'BinaryExpression',
  'ConditionalExpression',
  'TemplateExpression',
  'YieldExpression',
  'SpreadElement',
  'ClassExpression',
  'OmittedExpression',
  'ExpressionWithTypeArguments',
  'AsExpression',
  'NonNullExpression',
  'MetaProperty',
  'SyntheticExpression',
  'SatisfiesExpression',
  'TemplateSpan',
  'SemicolonClassElement',
  'Block',
  'EmptyStatement',
  'VariableStatement',
  'ExpressionStatement',
  'IfStatement',
  'DoStatement',
  'WhileStatement',
  'ForStatement',
  'ForInStatement',
  'ForOfStatement',
  'ContinueStatement',
  'BreakStatement',
  'ReturnStatement',
  'WithStatement',
  'SwitchStatement',
  'LabeledStatement',
  'ThrowStatement',
  'TryStatement',
  'DebuggerStatement',
  'VariableDeclaration',
  'VariableDeclarationList',
  'FunctionDeclaration',
  'ClassDeclaration',
  'InterfaceDeclaration',
  'TypeAliasDeclaration',
  'EnumDeclaration',
  'ModuleDeclaration',
  'ModuleBlock',
  'CaseBlock',
  'NamespaceExportDeclaration',
  'ImportEqualsDeclaration',
  'ImportDeclaration',
  'ImportClause',
  'NamespaceImport',
  'NamedImports',
  'ImportSpecifier',
  'ExportAssignment',
  'ExportDeclaration',
  'NamedExports',
  'NamespaceExport',
  'ExportSpecifier',
  'MissingDeclaration',
  'ExternalModuleReference',
  'JsxElement',
  'JsxSelfClosingElement',
  'JsxOpeningElement',
  'JsxClosingElement',
  'JsxFragment',
  'JsxOpeningFragment',
  'JsxClosingFragment',
  'JsxAttribute',
  'JsxAttributes',
  'JsxSpreadAttribute',
  'JsxExpression',
  'JsxNamespacedName',
  'CaseClause',
  'DefaultClause',
  'HeritageClause',
  'CatchClause',
  'ImportAttributes',
  'ImportAttribute',
  'PropertyAssignment',
  'ShorthandPropertyAssignment',
  'SpreadAssignment',
  'EnumMember',
  'SourceFile',
  'Bundle',
  'JSDocTypeExpression',
  'JSDocNameReference',
  'JSDocMemberName',
  'JSDocAllType',
  'JSDocUnknownType',
  'JSDocNullableType',
  'JSDocNonNullableType',
  'JSDocOptionalType',
  'JSDocFunctionType',
  'JSDocVariadicType',
  'JSDocNamepathType',
  'JSDoc',
  'JSDocComment',
  'JSDocText',
  'JSDocTypeLiteral',
  'JSDocSignature',
  'JSDocLink',
  'JSDocLinkCode',
  'JSDocLinkPlain',
  'JSDocTag',
  'JSDocAugmentsTag',
  'JSDocImplementsTag',
  'JSDocAuthorTag',
  'JSDocDeprecatedTag',
  'JSDocClassTag',
  'JSDocPublicTag',
  'JSDocPrivateTag',
  'JSDocProtectedTag',
  'JSDocReadonlyTag',
  'JSDocOverrideTag',
  'JSDocCallbackTag',
  'JSDocOverloadTag',
  'JSDocEnumTag',
  'JSDocParameterTag',
  'JSDocReturnTag',
  'JSDocThisTag',
  'JSDocTypeTag',
  'JSDocTemplateTag',
  'JSDocTypedefTag',
  'JSDocSeeTag',
  'JSDocPropertyTag',
  'JSDocThrowsTag',
  'JSDocSatisfiesTag',
  'JSDocImportTag',
  'SyntaxList',
  'NotEmittedStatement',
  'NotEmittedTypeElement',
  'PartiallyEmittedExpression',
  'CommaListExpression',
  'SyntheticReferenceExpression',
  'Count',
  'FirstAssignment',
  'LastAssignment',
  'FirstCompoundAssignment',
  'LastCompoundAssignment',
  'FirstReservedWord',
  'LastReservedWord',
  'FirstKeyword',
  'LastKeyword',
  'FirstFutureReservedWord',
  'LastFutureReservedWord',
  'FirstTypeNode',
  'LastTypeNode',
  'FirstPunctuation',
  'LastPunctuation',
  'FirstToken',
  'LastToken',
  'FirstTriviaToken',
  'LastTriviaToken',
  'FirstLiteralToken',
  'LastLiteralToken',
  'FirstTemplateToken',
  'LastTemplateToken',
  'FirstBinaryOperator',
  'LastBinaryOperator',
  'FirstStatement',
  'LastStatement',
  'FirstNode',
  'FirstJSDocNode',
  'LastJSDocNode',
  'FirstJSDocTagNode',
  'LastJSDocTagNode',
];

const privatify = {
  type: 'program',
  factory: (program: ts.Program) => {
    return (context: ts.TransformationContext) => {
      return (sourceFile: ts.SourceFile) => {
        const visit = (node: ts.Node): ts.Node => {
          // 处理属性
          if (
            ts.isPropertyDeclaration(node) &&
            node.modifiers &&
            node.modifiers.some((mod) => mod.kind === ts.SyntaxKind.PrivateKeyword) &&
            ts.isIdentifier(node.name)
          ) {
            // 移除 private 修饰符
            const newModifiers = node.modifiers.filter(
              (mod) => mod.kind !== ts.SyntaxKind.PrivateKeyword
            );
            // 替换为 #xxx
            const newName = ts.factory.createPrivateIdentifier('#' + node.name.text);
            return ts.factory.updatePropertyDeclaration(
              node,
              newModifiers,
              newName,
              node.questionToken,
              node.type,
              node.initializer
            );
          }
          // 处理方法
          if (
            ts.isMethodDeclaration(node) &&
            node.modifiers &&
            node.modifiers.some((mod) => mod.kind === ts.SyntaxKind.PrivateKeyword) &&
            ts.isIdentifier(node.name)
          ) {
            const newModifiers = node.modifiers.filter(
              (mod) => mod.kind !== ts.SyntaxKind.PrivateKeyword
            );
            const newName = ts.factory.createPrivateIdentifier('#' + node.name.text);

            return ts.factory.updateMethodDeclaration(
              node,
              newModifiers,
              node.asteriskToken,
              newName,
              node.questionToken,
              node.typeParameters,
              node.parameters,
              node.type,
              node.body
            );
          }
          return ts.visitEachChild(node, visit, context);
        };
        return ts.visitEachChild(sourceFile, visit, context);
      };
    };
  },
};
export default [privatify];
